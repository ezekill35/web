<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sistema de Gesti√≥n PetShop</title>
    <style>
        /* --- Estilos de Autenticaci√≥n (Login/Register) --- */
        :root {
            --primary-color: #6a0dad; /* P√∫rpura */
            --secondary-color: #ff9900; /* Naranja */
            --background-light: #f4f4f9;
            --text-dark: #333;
            --subtle-text: #777;
            --card-bg: #fff;
            --danger-color: #dc3545;
            --success-color: #28a745;
        }

        body {
            font-family: 'Arial', sans-serif;
            margin: 0;
            padding: 0;
            background-color: var(--background-light);
            color: var(--text-dark);
            display: flex;
            min-height: 100vh;
            flex-direction: column;
        }

        #auth-section {
            display: flex;
            justify-content: center;
            align-items: center;
            height: 100vh;
            background-color: var(--primary-color);
        }

        .auth-container {
            background: var(--card-bg);
            padding: 40px;
            border-radius: 10px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
            width: 350px;
            max-width: 90%; /* Asegura que no se desborde en pantallas peque√±as */
            text-align: center;
        }

        .auth-container h2 {
            color: var(--primary-color);
            margin-bottom: 20px;
        }

        /* ESTILOS PARA MOSTRAR CONTRASE√ëA */
        .password-container {
            position: relative;
            width: 100%;
            margin-bottom: 15px; 
        }
        
        .auth-container input[type="text"],
        .auth-container input[type="password"] {
            width: 100%;
            padding: 12px;
            border: 1px solid #ccc;
            border-radius: 6px;
            box-sizing: border-box;
        }
        
        .auth-container .password-container input {
            margin-bottom: 0;
        }

        .toggle-password {
            position: absolute;
            right: 15px;
            top: 50%;
            transform: translateY(-50%);
            cursor: pointer;
            color: var(--subtle-text);
            transition: color 0.2s;
            z-index: 10;
        }

        .toggle-password:hover {
            color: var(--primary-color);
        }

        .auth-container button {
            width: 100%;
            padding: 12px;
            margin-top: 10px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-weight: bold;
            transition: background-color 0.3s;
        }

        .auth-container .primary-btn {
            background-color: var(--secondary-color);
            color: white;
        }

        .auth-container .primary-btn:hover {
            background-color: #e68a00;
        }

        .auth-container .secondary-btn {
            background-color: #ddd;
            color: var(--text-dark);
            margin-top: 15px;
        }

        .auth-container .secondary-btn:hover {
            background-color: #ccc;
        }

        #register-form { display: none; }
        .error-message { color: var(--danger-color); margin-top: 10px; font-size: 0.9em; }
        .success-message { color: var(--success-color); margin-top: 10px; font-size: 0.9em; }

        /* --- Estilos del Dashboard (App principal) --- */
        #main-app {
            display: none; 
            grid-template-columns: 250px 1fr; /* Dise√±o de escritorio */
            flex-grow: 1;
        }

        .sidebar {
            background-color: var(--primary-color);
            color: white;
            padding: 20px 0;
            box-shadow: 2px 0 5px rgba(0, 0, 0, 0.1);
            position: sticky; 
            top: 0;
            height: 100vh;
        }

        .sidebar h1 {
            text-align: center;
            font-size: 1.5em;
            margin-bottom: 30px;
        }
        
        .sidebar p {
            text-align: center;
            font-size: 0.9em;
            margin-top: -20px;
            margin-bottom: 30px;
        }

        .nav-list {
            list-style: none;
            padding: 0;
            margin: 0;
        }

        .nav-item {
            padding: 15px 20px;
            cursor: pointer;
            transition: background-color 0.3s, padding-left 0.3s;
            display: flex;
            align-items: center;
        }

        .nav-item:hover, .nav-item.active {
            background-color: #8a2be2; 
            padding-left: 30px;
        }
        
        .nav-item i {
            margin-right: 10px;
            font-size: 1.2em;
        }

        .main-content {
            padding: 30px;
            overflow-y: auto;
        }

        header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 25px;
            border-bottom: 1px solid #ddd;
            padding-bottom: 15px;
            /* Fija la cabecera para cuando se hace scroll */
            position: sticky;
            top: 0;
            background-color: var(--background-light);
            z-index: 5; 
        }

        header h2 {
            color: var(--primary-color);
        }
        
        /* Estilo para el nuevo bot√≥n de men√∫ en m√≥vil */
        .menu-toggle-btn {
            display: none; /* Oculto por defecto en escritorio */
            background: none;
            border: none;
            font-size: 1.5em;
            cursor: pointer;
            color: var(--primary-color);
            padding: 0;
        }

        .user-controls {
            display: flex;
            align-items: center;
        }

        .user-controls button {
            background: var(--danger-color);
            color: white;
            border: none;
            padding: 8px 15px;
            border-radius: 5px;
            cursor: pointer;
            margin-left: 15px;
        }
        
        /* --- Secciones de Contenido --- */
        .content-section {
            display: none;
        }

        .content-section.active {
            display: block;
        }

        /* Contenedor de tarjetas flexible */
        .card-container {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); 
            gap: 20px;
            margin-bottom: 30px;
        }

        .stat-card {
            background: var(--card-bg);
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.05);
            border-left: 5px solid var(--secondary-color);
        }

        .stat-card h4 {
            color: var(--subtle-text);
            margin-top: 0;
            font-size: 1em;
        }

        .stat-card .value {
            font-size: 2em;
            font-weight: bold;
            color: var(--primary-color);
        }

        /* --- Formularios --- */
        .form-area {
            background: var(--card-bg);
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.05);
            margin-bottom: 30px;
        }

        .form-area h3 {
            border-bottom: 2px solid #eee;
            padding-bottom: 10px;
            margin-bottom: 20px;
            color: var(--primary-color);
        }

        .form-grid {
            display: grid;
            /* Permite 2 columnas en escritorio, 1 en m√≥vil */
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); 
            gap: 15px;
        }

        .form-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
            font-size: 0.9em;
        }

        .form-group input, .form-group select, .form-group textarea {
            width: 100%;
            padding: 10px;
            border: 1px solid #ccc;
            border-radius: 4px;
            box-sizing: border-box;
        }

        .form-actions {
            grid-column: 1 / -1; 
            margin-top: 20px;
            text-align: right;
        }

        .form-actions button {
            padding: 10px 20px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-weight: bold;
            transition: background-color 0.3s;
        }

        .form-actions .primary-btn {
            background-color: var(--secondary-color);
            color: white;
            margin-left: 10px;
        }
        
        .form-actions .secondary-btn {
            background-color: #ccc;
            color: var(--text-dark);
        }
        
        /* Estilos de botones de acci√≥n en tablas/cards */
        .action-buttons button, .data-table button {
            padding: 5px 10px;
            margin: 2px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 0.8em;
            font-weight: bold;
        }
        
        .action-buttons .edit-btn, .data-table .edit-btn {
             background-color: var(--primary-color);
             color: white;
        }
        
        .action-buttons .delete-btn, .data-table .delete-btn {
             background-color: var(--danger-color);
             color: white;
        }

        /* --- Tablas y Listas --- */
        .data-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
            background: var(--card-bg);
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.05);
            border-radius: 8px;
            overflow: hidden;
            table-layout: auto; /* Usar auto para que se adapte al contenido */
        }
        
        .data-table th, .data-table td {
            padding: 12px 10px;
            text-align: left;
            border-bottom: 1px solid #eee;
            word-wrap: break-word;
        }

        .data-table th {
            background-color: var(--primary-color);
            color: white;
            font-weight: bold;
            text-transform: uppercase;
            font-size: 0.75em; 
        }

        .data-table tr:nth-child(even) {
            background-color: #f9f9f9;
        }
        
        /* Responsividad en tablas - Permite scroll horizontal si no cabe */
        .data-table-responsive {
            overflow-x: auto; 
            width: 100%; 
        }

        /* --- Estilos de Proveedores y Productos (dem√°s) --- */
        .provider-card {
            background: var(--card-bg);
            padding: 15px;
            border-radius: 8px;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
            border-top: 3px solid var(--secondary-color);
            margin-bottom: 15px;
        }
        
        .provider-card h4 {
            margin-bottom: 5px;
        }
        
        .expense-item {
             display: flex;
             justify-content: space-between;
             padding: 10px 15px;
             border-bottom: 1px dashed #eee;
             background: var(--card-bg);
             align-items: center;
        }
        .expense-item:last-child {
             border-bottom: none;
        }
        .expense-item span:first-child {
             max-width: 70%;
        }
        .expense-item button {
             margin-left: 10px;
        }


        .low-stock { color: var(--secondary-color); font-weight: bold; }
        .out-of-stock { color: var(--danger-color); font-weight: bold; }
        .stock { color: var(--success-color); }

        /* Utilidades */
        .full-width { grid-column: 1 / -1; }
        .hidden { display: none; }
        
        /* ============================================================= */
        /* === MEDIA QUERY: RESPONSIVIDAD PARA M√ìVILES Y TABLETAS PEQUE√ëAS === */
        /* ============================================================= */
        @media (max-width: 768px) {
            
            /* 1. LAYOUT PRINCIPAL: Columna simple */
            #main-app {
                grid-template-columns: 1fr; /* Una sola columna */
            }
            
            /* 2. SIDEBAR: Ocultar y hacerlo un men√∫ desplegable */
            .sidebar {
                position: fixed; /* Fijo para que se superponga */
                top: 0;
                left: -250px; /* Inicialmente oculto a la izquierda */
                width: 250px;
                height: 100%;
                z-index: 10; /* Debe estar por encima del contenido principal */
                transition: left 0.3s ease;
                padding-top: 80px; /* Espacio para que no lo tape la cabecera */
                box-shadow: 5px 0 15px rgba(0, 0, 0, 0.3);
            }

            .sidebar.active {
                left: 0; /* Mostrar el sidebar */
            }
            
            /* 3. BOT√ìN DE MEN√ö: Mostrar el bot√≥n de hamburguesa */
            .menu-toggle-btn {
                display: block; 
            }
            
            /* 4. MAIN CONTENT: Reducir padding */
            .main-content {
                padding: 15px;
            }
            
            /* 5. CABECERA: Ajustar */
            header {
                padding-top: 5px;
            }
            
            /* 6. CONTROLES DE USUARIO: Botones m√°s peque√±os y mejor distribuidos */
            .user-controls {
                 flex-wrap: wrap; /* Permite que los controles se envuelvan si es necesario */
                 justify-content: flex-end;
            }
            .user-controls button {
                margin-left: 10px;
                padding: 6px 12px;
                font-size: 0.9em;
            }
            
            /* 7. RESUMEN R√ÅPIDO: Las secciones de 2 columnas se convierten en 1 columna */
            .card-container[style*="grid-template-columns: 1fr 1fr;"] {
                grid-template-columns: 1fr !important;
            }
        }
        /* ============================================================= */

    </style>
</head>
<body>
    
    <div id="auth-section">
        <div class="auth-container">
            <div id="login-form">
                <h2>Iniciar Sesi√≥n üêæ</h2>
                <input type="text" id="login-username" placeholder="Nombre de usuario" required onkeypress="handleKeyPress(event, 'login')">
                
                <div class="password-container">
                    <input type="password" id="login-password" placeholder="Contrase√±a" required onkeypress="handleKeyPress(event, 'login')">
                    <i class="fas fa-eye-slash toggle-password" onclick="togglePasswordVisibility('login-password', this)"></i>
                </div>
                
                <p class="error-message" id="login-error"></p>
                <button class="primary-btn" onclick="login()">Entrar</button>
                <button class="secondary-btn" id="register-toggle-btn" onclick="toggleAuthForm()">Crear una Cuenta</button>
            </div>
            
            <div id="register-form">
                <h2>Crear Cuenta</h2>
                <input type="text" id="reg-username" placeholder="Nombre de usuario" required onkeypress="handleKeyPress(event, 'register')">
                
                <div class="password-container">
                    <input type="password" id="reg-password" placeholder="Contrase√±a" required onkeypress="handleKeyPress(event, 'register')">
                    <i class="fas fa-eye-slash toggle-password" onclick="togglePasswordVisibility('reg-password', this)"></i>
                </div>
                
                <p class="error-message" id="register-error"></p>
                <p class="success-message" id="register-success"></p>
                <button class="primary-btn" onclick="register()">Registrar</button>
                <button class="secondary-btn" onclick="toggleAuthForm()">Ya tengo cuenta</button>
            </div>
        </div>
    </div>

    <div id="main-app">
        <aside class="sidebar"> 
            <h1>PetShop Manager</h1>
            <p>Bienvenido, <span id="welcome-username"></span></p>
            <ul class="nav-list">
                <li class="nav-item active" onclick="showSection('overview'); closeSidebar();"><i class="fas fa-tachometer-alt"></i> Dashboard</li>
                <li class="nav-item" onclick="showSection('products'); closeSidebar();"><i class="fas fa-boxes"></i> Inventario / Productos</li>
                <li class="nav-item" onclick="showSection('invoices'); closeSidebar();"><i class="fas fa-file-invoice-dollar"></i> Facturas de Compra</li>
                <li class="nav-item" onclick="showSection('sales'); closeSidebar();"><i class="fas fa-cash-register"></i> Ventas</li>
                <li class="nav-item" onclick="showSection('providers'); closeSidebar();"><i class="fas fa-truck-loading"></i> Proveedores</li>
                <li class="nav-item" onclick="showSection('expenses'); closeSidebar();"><i class="fas fa-money-bill-wave"></i> Gastos</li>
                <li class="nav-item" onclick="showSection('contact'); closeSidebar();"><i class="fas fa-envelope"></i> Contacto Proveedores</li>
                <li class="nav-item" onclick="logout(); closeSidebar();" style="margin-top: 30px;"><i class="fas fa-sign-out-alt"></i> Cerrar Sesi√≥n</li>
            </ul>
        </aside>

        <main class="main-content">
            <header>
                <div style="display: flex; align-items: center;">
                    <button class="menu-toggle-btn" onclick="toggleSidebar()"><i class="fas fa-bars"></i></button>
                    <h2 id="dashboard-title" style="margin-left: 15px;">Dashboard</h2>
                </div>
                <div class="user-controls">
                    <select onchange="changeCurrency(this.value)" style="padding: 5px;">
                        <option value="PEN">Soles (PEN)</option>
                        <option value="USD">D√≥lares (USD)</option>
                    </select>
                    <button onclick="logout()">Cerrar Sesi√≥n</button>
                </div>
            </header>

            <section id="overview-section" class="content-section active">
                <h3>Resumen R√°pido</h3>
                <div class="card-container">
                    <div class="stat-card">
                        <h4>Total de Productos</h4>
                        <p class="value" id="total-products">0</p>
                    </div>
                    <div class="stat-card">
                        <h4>Stock Bajo (&lt; 10 unid.)</h4>
                        <p class="value" id="low-stock-count">0</p>
                    </div>
                    <div class="stat-card">
                        <h4>Total de Proveedores</h4>
                        <p class="value" id="total-providers">0</p>
                    </div>
                    <div class="stat-card">
                        <h4>Ventas del Mes</h4>
                        <p class="value" id="monthly-sales">$ 0.00</p>
                    </div>
                </div>
                
                <div class="card-container" style="grid-template-columns: 1fr 1fr;">
                    <div class="form-area">
                        <h3>√öltimas Facturas de Compra</h3>
                        <div class="data-table-responsive">
                            <div id="invoices-list-view-overview"></div>
                        </div>
                    </div>
                    <div class="form-area">
                        <h3>√öltimas Ventas</h3>
                         <div class="data-table-responsive">
                            <div id="sales-list-view-overview"></div>
                        </div>
                    </div>
                </div>
            </section>

            <section id="products-section" class="content-section">
                <div class="form-area">
                    <h3 id="product-form-title">‚ûï Agregar Nuevo Producto</h3>
                    <form id="add-product-form" onsubmit="event.preventDefault(); addProduct();">
                        <div class="form-grid">
                            <div class="form-group"><label for="product-code">C√≥digo / SKU (*)</label><input type="text" id="product-code" required></div>
                            <div class="form-group"><label for="product-description">Descripci√≥n</label><input type="text" id="product-description"></div>
                            <div class="form-group"><label for="product-brand">Marca</label><input type="text" id="product-brand"></div>
                            <div class="form-group"><label for="product-price">Precio Venta S/ (*)</label><input type="number" id="product-price" step="0.01" required></div>
                            <div class="form-group"><label for="product-stock">Stock Inicial (*)</label><input type="number" id="product-stock" required></div>
                            <div class="form-group"><label for="product-unit-of-measure">Unidad de Medida</label><input type="text" id="product-unit-of-measure" value="unidades"></div>
                            
                            <div class="form-group">
                                <label for="product-animal">Para</label>
                                <select id="product-animal">
                                    <option value="perros">Perros</option>
                                    <option value="gatos">Gatos</option>
                                    <option value="ambos">Ambos</option>
                                    <option value="otros">Otros animales</option>
                                </select>
                            </div>
                            
                            <div class="form-group">
                                <label for="product-category">Categor√≠a (*)</label>
                                <select id="product-category" onchange="toggleOtherProductCategory()">
                                    <option value="arnes-correas">Arneses / Correas / Collares</option>
                                    <option value="juguetes">Juguetes</option>
                                    <option value="rascadores-camas">Rascadores / Camas / Descanso</option>
                                    <option value="higiene-aseo">Higiene / Aseo (Shampoo, Cepillos)</option>
                                    <option value="transportadoras">Transportadoras / Cajas</option>
                                    <option value="ropa">Ropa / Abrigos</option>
                                    <option value="otros">Otros Accesorios</option>
                                </select>
                            </div>
                            <div class="form-group hidden" id="other-product-category-container">
                                <label for="product-category-other">Especifique la Categor√≠a</label>
                                <input type="text" id="product-category-other">
                            </div>
                        </div>
                        <div class="form-actions">
                            <button type="button" class="secondary-btn" onclick="clearProductForm()">Limpiar</button>
                            <button type="submit" class="primary-btn" id="add-product-btn">Agregar Producto</button>
                        </div>
                    </form>
                </div>

                <div class="form-area">
                    <h3>üîç B√∫squeda de Productos</h3>
                    <div id="product-search-area">
                        <input type="text" id="product-search" placeholder="Buscar por c√≥digo o nombre..." oninput="searchProducts()">
                    </div>
                    <div id="product-results">
                        </div>
                </div>

                <div class="form-area">
                     <div class="data-table-responsive">
                        <div id="product-list-view">
                        </div>
                    </div>
                </div>
            </section>

            <section id="invoices-section" class="content-section">
                <div class="form-area">
                    <h3 id="invoice-form-title">‚ûï Registrar Factura de Compra (Proveedor)</h3>
                    <form id="add-invoice-form" onsubmit="event.preventDefault(); addInvoice();">
                        <div class="form-grid">
                            <div class="form-group"><label for="invoice-ruc">RUC Factura (*)</label><input type="text" id="invoice-ruc" required></div>
                            <div class="form-group"><label for="invoice-number">N√∫mero de Factura (*)</label><input type="text" id="invoice-number" required></div>
                            <div class="form-group">
                                <label for="invoice-document-type">Tipo de Documento</label>
                                <select id="invoice-document-type">
                                    <option value="factura-electronica">Factura Electr√≥nica</option>
                                    <option value="boleta-electronica">Boleta Electr√≥nica</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label for="invoice-provider">Proveedor (*)</label>
                                <select id="invoice-provider" required>
                                    <option value="">Seleccione un proveedor</option>
                                </select>
                            </div>
                            <div class="form-group full-width"><hr style="border-top: 1px dashed #ccc;"></div>
                            
                            <div class="form-group">
                                <label for="invoice-product">Producto de Inventario (*)</label>
                                <select id="invoice-product" required onchange="updateProductFields()">
                                    <option value="">Seleccione un producto</option>
                                </select>
                            </div>
                            <div class="form-group"><label for="invoice-description">Descripci√≥n Factura (*)</label><input type="text" id="invoice-description" required></div>
                            <div class="form-group"><label for="invoice-brand">Marca (*)</label><input type="text" id="invoice-brand" required></div>
                            <div class="form-group"><label for="invoice-unit-of-measure">Und. (*)</label><input type="text" id="invoice-unit-of-measure" value="jgo" required></div>

                            <div class="form-group">
                                <label for="invoice-quantity">Cantidad (*)</label>
                                <input type="number" id="invoice-quantity" required oninput="calculateInvoiceTotals()">
                            </div>
                            <div class="form-group">
                                <label for="invoice-sale-price">Precio Venta S/ (*)</label> 
                                <input type="number" id="invoice-sale-price" step="0.01" required placeholder="Precio de Venta Sugerido">
                            </div>
                            <div class="form-group">
                                <label for="invoice-unit-price">Valor Unitario (Compra) S/ (*)</label>
                                <input type="number" id="invoice-unit-price" step="0.01" required oninput="calculateInvoiceTotals()">
                            </div>
                            
                            <div class="form-group">
                                <label for="invoice-discount-rate">% Dsct. Proveedor</label>
                                <input type="number" id="invoice-discount-rate" step="0.01" value="0" oninput="calculateInvoiceTotals()">
                            </div>

                            <div class="form-group">
                                <label for="invoice-tax-rate">Tasa de Impuesto (%)</label>
                                <select id="invoice-tax-rate" onchange="calculateInvoiceTotals()">
                                    <option value="0">0% (Exonerado)</option>
                                    <option value="18" selected>18% (IVA/IGV)</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label for="invoice-base-amount">Base Imponible (Subtotal S/)</label>
                                <input type="number" id="invoice-base-amount" step="0.01" readonly style="background-color: #f0f0f0;">
                            </div>
                            <div class="form-group">
                                <label for="invoice-tax-amount">Monto Impuesto S/</label>
                                <input type="number" id="invoice-tax-amount" step="0.01" readonly style="background-color: #f0f0f0;">
                            </div>
                            <div class="form-group">
                                <label for="invoice-total">Monto Total de Factura S/ (*)</label>
                                <input type="number" id="invoice-total" step="0.01" required readonly style="background-color: #ffe0b2;">
                            </div>
                            <div class="form-group full-width">
                                <label for="invoice-date">Fecha de Emisi√≥n (*)</label>
                                <input type="date" id="invoice-date" required>
                            </div>
                        </div>
                        <div class="form-actions">
                            <button type="button" class="secondary-btn" onclick="clearInvoiceForm()">Limpiar</button>
                            <button type="submit" class="primary-btn">Registrar Factura</button>
                        </div>
                    </form>
                </div>
                
                <div class="form-area">
                    <div class="data-table-responsive">
                        <div id="invoices-list-view">
                        </div>
                    </div>
                </div>
            </section>

            <section id="sales-section" class="content-section">
                <div class="form-area">
                    <h3>‚ûï Registrar Venta (Cliente)</h3>
                    <form id="add-sale-form" onsubmit="event.preventDefault(); addSale();">
                        <div class="form-grid">
                            <div class="form-group"><label for="sale-number">N¬∞ de Documento</label><input type="text" id="sale-number"></div>
                            <div class="form-group"><label for="sale-client">Cliente (Opcional)</label><input type="text" id="sale-client"></div>
                            <div class="form-group">
                                <label for="sale-product">Producto (*)</label>
                                <select id="sale-product" required>
                                    <option value="">Seleccione un producto</option>
                                </select>
                            </div>
                            <div class="form-group"><label for="sale-quantity">Cantidad (*)</label><input type="number" id="sale-quantity" required></div>
                            <div class="form-group"><label for="sale-unit-price">Precio Unitario S/ (*)</label><input type="number" id="sale-unit-price" step="0.01" required></div>
                            <div class="form-group"><label for="sale-date">Fecha de Venta (*)</label><input type="date" id="sale-date" required></div>
                        </div>
                        <div class="form-actions">
                            <button type="button" class="secondary-btn" onclick="clearSaleForm()">Limpiar</button>
                            <button type="submit" class="primary-btn">Registrar Venta</button>
                        </div>
                    </form>
                </div>
                
                <div class="form-area">
                    <div class="data-table-responsive">
                        <div id="sales-list">
                        </div>
                    </div>
                </div>
            </section>

            <section id="providers-section" class="content-section">
                <div class="form-area">
                    <h3 id="provider-form-title">‚ûï Agregar Nuevo Proveedor</h3>
                    <form id="add-provider-form" onsubmit="event.preventDefault(); addProvider();">
                        <input type="hidden" id="provider-id-to-edit">
                        <div class="form-grid">
                            <div class="form-group"><label for="provider-name">Nombre del Contacto (*)</label><input type="text" id="provider-name" required></div>
                            <div class="form-group"><label for="provider-trade-name">Nombre Comercial (*)</label><input type="text" id="provider-trade-name" required></div>
                            <div class="form-group"><label for="provider-phone">Tel√©fono (*)</label><input type="text" id="provider-phone" required></div>
                            <div class="form-group"><label for="provider-fax">Fax (Opcional)</label><input type="text" id="provider-fax"></div>
                            
                            <div class="form-group full-width"><label for="provider-address">Direcci√≥n</label><input type="text" id="provider-address"></div>
                            
                            <div class="form-group full-width">
                                <label for="provider-product-type-text">Tipo de Producto</label>
                                <input type="text" id="provider-product-type-text" placeholder="Ej: Alimento Seco, Juguetes de Goma, Medicamentos">
                            </div>
                        </div>
                        <div class="form-actions">
                            <button type="button" class="secondary-btn" id="cancel-edit-btn" style="display:none;" onclick="cancelEditProvider()">Cancelar Edici√≥n</button>
                            <button type="submit" class="primary-btn" id="add-provider-btn">Agregar Proveedor</button>
                        </div>
                    </form>
                </div>

                <div class="form-area">
                    <h3>üë• Proveedores Registrados</h3>
                    <div id="provider-search-area" style="position: relative;">
                        <input type="text" id="provider-search" placeholder="Buscar por Nombre o Tel√©fono..." oninput="searchProviders()">
                        <button class="secondary-btn" style="margin-left: 10px;" onclick="viewAllProviders()">Ver Todos</button>
                        <div id="provider-suggestions"></div>
                    </div>
                    <div id="provider-results">
                        </div>
                </div>
            </section>

            <section id="expenses-section" class="content-section">
                <div class="form-area">
                    <h3>‚ûï Registrar Gasto Operativo</h3>
                    <form id="add-expense-form" onsubmit="event.preventDefault(); addExpense();">
                        <div class="form-grid">
                            <div class="form-group"><label for="expense-description">Descripci√≥n (*)</label><input type="text" id="expense-description" required></div>
                            <div class="form-group">
                                <label for="expense-type">Tipo de Gasto (*)</label>
                                <select id="expense-type" required>
                                    <option value="alquiler">Alquiler</option>
                                    <option value="servicios">Servicios (Luz, Agua, Internet)</option>
                                    <option value="sueldos">Sueldos/Salarios</option>
                                    <option value="marketing">Marketing/Publicidad</option>
                                    <option value="otros">Otros</option>
                                </select>
                            </div>
                            <div class="form-group"><label for="expense-quantity">Cantidad (*)</label><input type="number" id="expense-quantity" value="1" required oninput="calculateExpenseTotal()"></div>
                            <div class="form-group"><label for="expense-unit-value">Valor Unitario S/ (*)</label><input type="number" id="expense-unit-value" step="0.01" required oninput="calculateExpenseTotal()"></div>
                            <div class="form-group"><label for="expense-total">Total Gasto S/</label><input type="number" id="expense-total" step="0.01" readonly style="background-color: #ffe0b2;"></div>
                            <div class="form-group"><label for="expense-date">Fecha de Gasto (*)</label><input type="date" id="expense-date" required></div>
                        </div>
                        <div class="form-actions">
                            <button type="button" class="secondary-btn" onclick="clearExpenseForm()">Limpiar</button>
                            <button type="submit" class="primary-btn">Registrar Gasto</button>
                        </div>
                    </form>
                </div>

                <div class="form-area">
                    <h3>üìä Resumen de Gastos</h3>
                    <div class="movement-list" id="expenses-list">
                        </div>
                    <div id="expense-total-summary" style="padding: 15px; text-align: right; font-weight: bold; background: #eee;">Total: S/ 0.00</div>
                </div>
            </section>

            <section id="contact-section" class="content-section">
                <div class="form-area">
                    <h3>üìß Enviar Correo a Proveedor</h3>
                    <form id="contact-form" onsubmit="event.preventDefault(); sendEmail();">
                        <div class="form-group">
                            <label for="contact-provider-select">Seleccione Proveedor (*)</label>
                            <select id="contact-provider-select" required>
                                <option value="">Seleccione un proveedor</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="contact-subject">Asunto (*)</label>
                            <input type="text" id="contact-subject" required value="Consulta de Productos y Precios">
                        </div>
                        <div class="form-group">
                            <label for="contact-message">Mensaje (*)</label>
                            <textarea id="contact-message" rows="6" required>Estimados,

Por favor, env√≠enme su lista de precios actualizada y el cat√°logo de productos disponible.

Agradezco su pronta respuesta.</textarea>
                        </div>
                        <div class="form-actions">
                            <button type="submit" class="primary-btn">Enviar Correo (Simulado)</button>
                        </div>
                    </form>
                </div>
            </section>

        </main>
    </div>

    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css">
    
    <script>
        // --------------------------------------------------------
        // L√ìGICA DE RESPONSIVIDAD (NUEVAS FUNCIONES)
        // --------------------------------------------------------
        function toggleSidebar() {
            const sidebar = document.querySelector('.sidebar');
            // Agrega o quita la clase 'active' que el CSS usa para mostrar/ocultar el men√∫
            sidebar.classList.toggle('active'); 
        }

        function closeSidebar() {
            const sidebar = document.querySelector('.sidebar');
            // Cierra solo si la ventana es menor a 768px (m√≥vil/tablet)
            if (window.innerWidth <= 768) {
                sidebar.classList.remove('active');
            }
        }
        
        // Escucha el evento de redimensionamiento para asegurar que el sidebar se comporte correctamente
        window.addEventListener('resize', () => {
            const sidebar = document.querySelector('.sidebar');
            // Si la pantalla es grande, aseguramos que la clase 'active' no interfiera si se hab√≠a abierto antes.
            if (window.innerWidth > 768) {
                sidebar.classList.remove('active');
            }
        });
        
        // --------------------------------------------------------
        // MODO CONEXI√ìN A BASE DE DATOS (API REST SIMULADA y LOCALSTORAGE)
        // --------------------------------------------------------

        // Variables globales
        let users = []; 
        let products = [];
        let providers = [];
        let invoices = [];
        let sales = [];
        let expenses = [];
        let currentUser = null;
        let currentCurrency = 'PEN';
        const PEN_TO_USD_RATE = 0.26;
        
        // Claves de localStorage
        const USERS_KEY = 'petshop_users';
        const PRODUCTS_KEY = 'petshop_products';
        const PROVIDERS_KEY = 'petshop_providers';
        const INVOICES_KEY = 'petshop_invoices';
        const SALES_KEY = 'petshop_sales';
        const EXPENSES_KEY = 'petshop_expenses';
        // Variable de estado para el toggle de proveedores
        let isShowingAllProviders = false; 

        // Inicializar datos (Carga desde localStorage o usa datos de prueba/vac√≠os)
        function initializeData() {
            // 1. Cargar Usuarios
            const storedUsers = localStorage.getItem(USERS_KEY);
            if (storedUsers) {
                users = JSON.parse(storedUsers);
            }
            // Si no hay usuarios guardados, crear el usuario admin por defecto
            if (users.length === 0) {
                // Usuario de prueba: admin:admin123
                users = [{ username: 'admin', password: 'admin123' }];
                saveUsers();
            }

            // 2. Cargar otros datos (Si no existen, usar datos de prueba)
            products = JSON.parse(localStorage.getItem(PRODUCTS_KEY)) || [
                { id: 1, code: 'ARN001', name: 'Arn√©s Talla M Negro', brand: 'SecureWalk', description: 'Arn√©s para perros medianos', unitOfMeasure: 'unidades', price: 65.00, stock: 45, category: 'arnes-correas', animal: 'perros', providers: [] },
                { id: 2, code: 'JUG010', name: 'Pelota L√°tex', brand: 'PlayFun', description: 'Juguete resistente', unitOfMeasure: 'unidades', price: 12.50, stock: 5, category: 'juguetes', animal: 'gatos', providers: [] },
                { id: 3, code: 'RASC005', name: 'Rascador 3 Niveles', brand: 'GatoFeliz', description: 'Torre de descanso para gatos', unitOfMeasure: 'unidades', price: 89.90, stock: 0, category: 'rascadores-camas', animal: 'gatos', providers: [] }
            ];

            // Proveedores con Nombre Comercial, Fax (antes email) y Tipo de Producto (texto libre)
            providers = JSON.parse(localStorage.getItem(PROVIDERS_KEY)) || [
                { id: 101, name: 'Juan P√©rez', tradeName: 'Distribuidora PetFood S.A.C.', phone: '987654321', fax: '511-123456', productType: 'Alimentos Secos y H√∫medos', address: 'Av. Los Olivos 123' },
                { id: 102, name: 'Mar√≠a G√≥mez', tradeName: 'Accesorios Felices E.I.R.L.', phone: '999111222', fax: '511-654321', productType: 'Juguetes, Correas y Arneses', address: 'Jr. La Alameda 456' }
            ];

            invoices = JSON.parse(localStorage.getItem(INVOICES_KEY)) || [
                { id: 201, ruc: '20100052564', invoiceNumber: 'F001-100', documentType: 'factura-electronica', providerId: 101, productId: 1, descriptionFactura: 'Bolsa 15kg Alimento Premium', brand: 'NutriPet', unitOfMeasure: 'unidades', quantity: 20, salePrice: 65.00, unitPrice: 50.00, discountRate: 5, discountAmount: 50.00, baseAmount: 950.00, taxRate: 18, taxAmount: 171.00, total: 1121.00, date: '2025-09-01' }
            ];

            sales = JSON.parse(localStorage.getItem(SALES_KEY)) || [
                { id: 301, saleNumber: 'V-001', client: 'Juan Perez', productId: 1, quantity: 2, unitPrice: 65.00, total: 130.00, date: '2025-09-10' }
            ];

            expenses = JSON.parse(localStorage.getItem(EXPENSES_KEY)) || [
                { id: 401, description: 'Alquiler del local', type: 'alquiler', quantity: 1, unitValue: 800.00, total: 800.00, date: '2025-09-05' }
            ];

            // Guardar los datos de prueba al inicio si no exist√≠an para que persistan en el futuro
            saveAllData();
        }

        // Funciones para guardar en localStorage
        function saveUsers() { localStorage.setItem(USERS_KEY, JSON.stringify(users)); }
        function saveProducts() { localStorage.setItem(PRODUCTS_KEY, JSON.stringify(products)); }
        function saveProviders() { localStorage.setItem(PROVIDERS_KEY, JSON.stringify(providers)); }
        function saveInvoices() { localStorage.setItem(INVOICES_KEY, JSON.stringify(invoices)); }
        function saveSales() { localStorage.setItem(SALES_KEY, JSON.stringify(sales)); }
        function saveExpenses() { localStorage.setItem(EXPENSES_KEY, JSON.stringify(expenses)); }

        function saveAllData() {
            saveUsers();
            saveProducts();
            saveProviders();
            saveInvoices();
            saveSales();
            saveExpenses();
        }

        // SIMULACI√ìN DE API REST (Funciones de backend/persistencia)
        async function sendData(endpoint, method = 'POST', data = {}) {
            console.log(`[SIMULACI√ìN ${method}] Enviando a ${endpoint}:`, data);
            await new Promise(resolve => setTimeout(resolve, 500)); 
            
            let savedData = null;

            if (method === 'POST') {
                const simulatedId = Math.floor(Math.random() * 1000000) + 500;
                savedData = { id: simulatedId, ...data };
            } else if (method === 'PUT' && data.id) {
                const id = data.id;
                savedData = data;
            }

            // PERSISTENCIA: Guardar los datos en el array y localStorage
            if (endpoint === '/products') {
                if (method === 'POST') products.push(savedData);
                else if (method === 'PUT') {
                    const index = products.findIndex(p => p.id === savedData.id);
                    if (index !== -1) products[index] = savedData;
                }
                saveProducts();
            } else if (endpoint === '/providers') {
                if (method === 'POST') providers.push(savedData);
                else if (method === 'PUT') {
                    const index = providers.findIndex(p => p.id === savedData.id);
                    if (index !== -1) providers[index] = savedData;
                }
                saveProviders();
            } else if (endpoint === '/invoices') {
                invoices.push(savedData);
                saveInvoices();
            } else if (endpoint === '/sales') {
                sales.push(savedData);
                saveSales();
            } else if (endpoint === '/expenses') {
                expenses.push(savedData);
                saveExpenses();
            }

            return savedData;
        }

        async function deleteData(endpoint) {
            console.log(`[SIMULACI√ìN DELETE] Intentando eliminar en ${endpoint}`);
            await new Promise(resolve => setTimeout(resolve, 300)); 

            const parts = endpoint.split('/');
            const resource = parts[1];
            const idToDelete = parseInt(parts[2]);

            if (resource === 'products') {
                products = products.filter(p => p.id !== idToDelete);
                saveProducts();
                return true;
            } else if (resource === 'providers') {
                providers = providers.filter(p => p.id !== idToDelete);
                saveProviders();
                return true;
            } else if (resource === 'sales') {
                const saleToDelete = sales.find(s => s.id === idToDelete);
                if (saleToDelete) {
                    // 1. Devolver stock (Incrementar)
                    const product = products.find(p => p.id === saleToDelete.productId);
                    if (product) {
                        product.stock += saleToDelete.quantity;
                        saveProducts();
                    }
                    // 2. Eliminar venta
                    sales = sales.filter(s => s.id !== idToDelete);
                    saveSales();
                    return true;
                }
                return false;
            } else if (resource === 'invoices') {
                 const invoiceToDelete = invoices.find(i => i.id === idToDelete);
                if (invoiceToDelete) {
                    // 1. Revertir stock (Restar)
                    const product = products.find(p => p.id === invoiceToDelete.productId);
                    if (product) {
                        // Evitar stock negativo en la simulaci√≥n
                        product.stock = Math.max(0, product.stock - invoiceToDelete.quantity); 
                        saveProducts();
                    }
                    // 2. Eliminar factura
                    invoices = invoices.filter(i => i.id !== idToDelete);
                    saveInvoices();
                    return true;
                }
                return false;
            } else if (resource === 'expenses') {
                expenses = expenses.filter(e => e.id !== idToDelete);
                saveExpenses();
                return true;
            }

            return false;
        }

        // --------------------------------------------------------
        // L√ìGICA DE AUTENTICACI√ìN
        // --------------------------------------------------------

        function checkSession() {
            initializeData();
            const sessionUsername = localStorage.getItem('sessionUser');
            if (sessionUsername) {
                // Si hay sesi√≥n, intentamos cargar el dashboard
                currentUser = { username: sessionUsername };
                initializeDashboard();
            } else {
                // Si no hay sesi√≥n, siempre mostramos la autenticaci√≥n
                document.getElementById('auth-section').style.display = 'flex';
                document.getElementById('main-app').style.display = 'none';
                // Aseguramos que la vista inicial sea el login y mostramos el bot√≥n de registro
                const loginForm = document.getElementById('login-form');
                const registerForm = document.getElementById('register-form');
                const registerToggleBtn = document.getElementById('register-toggle-btn');

                loginForm.style.display = 'block';
                registerForm.style.display = 'none';
                registerToggleBtn.style.display = 'block'; // Habilitamos la opci√≥n de registro
            }
        }

        async function initializeDashboard() {
            document.getElementById('auth-section').style.display = 'none';
            // Usar 'grid' ya que es el valor por defecto en pantallas grandes (el media query lo cambia en m√≥vil)
            document.getElementById('main-app').style.display = 'grid'; 
            document.getElementById('welcome-username').textContent = currentUser.username;
            
            updateProviderSelects();
            updateContactProviderSelect();
            updateProductSelects();
            updateStats();
            renderInvoices();
            renderSales();
            renderExpenses();
            renderAllProducts();
            renderAllProviders();
        }

        function login() {
            const username = document.getElementById('login-username').value;
            const password = document.getElementById('login-password').value;
            const errorElement = document.getElementById('login-error');
            errorElement.textContent = '';

            const user = users.find(u => u.username === username && u.password === password);

            if (user) {
                localStorage.setItem('sessionUser', username);
                currentUser = user;
                initializeDashboard();
            } else {
                errorElement.textContent = 'Usuario o contrase√±a incorrectos.';
            }
        }

        function register() {
            const username = document.getElementById('reg-username').value;
            const password = document.getElementById('reg-password').value;
            const errorElement = document.getElementById('register-error');
            const successElement = document.getElementById('register-success');
            errorElement.textContent = '';
            successElement.textContent = '';

            if (username.length < 3) {
                errorElement.textContent = 'El nombre de usuario debe tener al menos 3 caracteres.';
                return;
            }

            if (password.length < 6) {
                errorElement.textContent = 'La contrase√±a debe tener al menos 6 caracteres.';
                return;
            }

            if (users.some(u => u.username === username)) {
                errorElement.textContent = 'El nombre de usuario ya existe.';
                return;
            }

            users.push({ username, password });
            saveUsers();
            successElement.textContent = 'Cuenta creada con √©xito. Ya puedes iniciar sesi√≥n.';
            
            // Volver al formulario de login
            setTimeout(toggleAuthForm, 1500); 
        }

        function logout() {
            localStorage.removeItem('sessionUser');
            currentUser = null;
            checkSession();
        }

        function toggleAuthForm() {
            const loginForm = document.getElementById('login-form');
            const registerForm = document.getElementById('register-form');
            
            if (loginForm.style.display === 'block' || loginForm.style.display === '') {
                loginForm.style.display = 'none';
                registerForm.style.display = 'block';
                document.getElementById('register-success').textContent = '';
                document.getElementById('register-error').textContent = '';
            } else {
                loginForm.style.display = 'block';
                registerForm.style.display = 'none';
                document.getElementById('login-error').textContent = '';
            }
        }

        function handleKeyPress(event, formType) {
            if (event.key === 'Enter') {
                event.preventDefault(); // Previene la acci√≥n por defecto del Enter
                if (formType === 'login') {
                    login();
                } else if (formType === 'register') {
                    register();
                }
            }
        }
        
        function togglePasswordVisibility(id, iconElement) {
            const passwordInput = document.getElementById(id);
            if (passwordInput.type === 'password') {
                passwordInput.type = 'text';
                iconElement.classList.remove('fa-eye-slash');
                iconElement.classList.add('fa-eye');
            } else {
                passwordInput.type = 'password';
                iconElement.classList.remove('fa-eye');
                iconElement.classList.add('fa-eye-slash');
            }
        }


        // --------------------------------------------------------
        // L√ìGICA DE NAVEGACI√ìN Y DASHBOARD
        // --------------------------------------------------------
        
        function formatCurrency(amount) {
            const symbol = currentCurrency === 'PEN' ? 'S/' : '$';
            return `${symbol} ${amount.toFixed(2)}`;
        }
        
        function changeCurrency(newCurrency) {
            currentCurrency = newCurrency;
            updateStats();
        }
        
        function convertAndFormat(amountPEN) {
            if (currentCurrency === 'USD') {
                const converted = amountPEN * PEN_TO_USD_RATE;
                return formatCurrency(converted);
            }
            return formatCurrency(amountPEN);
        }

        function updateStats() {
            const lowStockThreshold = 10;
            const lowStockCount = products.filter(p => p.stock > 0 && p.stock < lowStockThreshold).length;
            
            // Ventas del mes (Simulaci√≥n: Ventas de este mes, o de los √∫ltimos 30 d√≠as)
            const today = new Date();
            const monthStart = new Date(today.getFullYear(), today.getMonth(), 1);
            
            const monthlySalesAmount = sales
                .filter(s => new Date(s.date) >= monthStart)
                .reduce((total, sale) => total + sale.total, 0);

            const convertedSales = convertAndFormat(monthlySalesAmount).replace('$', '');
            
            document.getElementById('total-products').textContent = products.length;
            document.getElementById('low-stock-count').textContent = lowStockCount;
            document.getElementById('total-providers').textContent = providers.length;
            document.getElementById('monthly-sales').textContent = convertedSales;
            
            // Actualizar resumen de gastos
             updateExpenseSummary();
             // Actualizar listas de dashboard (para que muestren la moneda correcta)
             renderInvoicesOverview();
             renderSalesOverview();
        }

        function showSection(sectionName) {
            document.querySelectorAll('.content-section').forEach(section => {
                section.classList.remove('active');
            });
            document.querySelectorAll('.nav-item').forEach(item => {
                item.classList.remove('active');
            });

            document.getElementById(`${sectionName}-section`).classList.add('active');
            document.querySelector(`.nav-item[onclick*="showSection('${sectionName}')"]`).classList.add('active');
            
            // Obtenemos el texto del item de navegaci√≥n sin los √≠conos
            const navItem = document.querySelector(`.nav-item[onclick*="showSection('${sectionName}')"]`);
            let title = navItem.textContent.trim();
            if (navItem.querySelector('i')) {
                // Eliminar el contenido del icono para dejar solo el texto
                const iconContent = navItem.querySelector('i').textContent;
                title = title.replace(iconContent, '').trim(); 
            }
            document.getElementById('dashboard-title').textContent = title;
            
            // L√≥gica espec√≠fica al cambiar de secci√≥n
            if (sectionName === 'products') {
                 document.getElementById('product-search').value = '';
                 document.getElementById('product-results').innerHTML = '';
                 renderAllProducts(); // Re-renderizar la lista completa de productos
            } else if (sectionName === 'providers') {
                 viewAllProviders(); // Asegurarse de mostrar todos los proveedores
            }
            
            // Aseguramos que el select de proveedores est√© actualizado en Contacto y Facturas
            if (sectionName === 'contact' || sectionName === 'invoices') {
                updateProviderSelects();
                updateContactProviderSelect();
            }
            
            // Aseguramos que el select de productos est√© actualizado en Ventas y Facturas
             if (sectionName === 'sales' || sectionName === 'invoices') {
                updateProductSelects();
            }
        }


        // --------------------------------------------------------
        // L√ìGICA DE PRODUCTOS (INVENTARIO)
        // --------------------------------------------------------
        
        function updateProductSelects() {
            const productSelects = document.querySelectorAll('#sale-product, #invoice-product');
            
            productSelects.forEach(select => {
                const selectedValue = select.value;
                select.innerHTML = '<option value="">Seleccione un producto</option>';
                
                products.forEach(product => {
                    const option = document.createElement('option');
                    option.value = product.id;
                    option.textContent = `${product.name} (${product.code}) - Stock: ${product.stock}`;
                    select.appendChild(option);
                });
                
                // Restablecer el valor seleccionado si es posible
                if (selectedValue && select.querySelector(`option[value="${selectedValue}"]`)) {
                     select.value = selectedValue;
                }
            });
        }
        
        function toggleOtherProductCategory() {
            const categorySelect = document.getElementById('product-category');
            const otherContainer = document.getElementById('other-product-category-container');
            
            if (categorySelect.value === 'otros') {
                otherContainer.classList.remove('hidden');
            } else {
                otherContainer.classList.add('hidden');
            }
        }
        
        async function addProduct() {
            const isEditing = document.getElementById('add-product-btn').textContent.includes('Guardar');
            
            const code = document.getElementById('product-code').value;
            const name = document.getElementById('product-description').value; // Usamos descripci√≥n como nombre visible
            const description = document.getElementById('product-description').value;
            const brand = document.getElementById('product-brand').value;
            const price = parseFloat(document.getElementById('product-price').value);
            const stock = parseInt(document.getElementById('product-stock').value);
            const unitOfMeasure = document.getElementById('product-unit-of-measure').value;
            const animal = document.getElementById('product-animal').value;
            let category = document.getElementById('product-category').value;
            const categoryOther = document.getElementById('product-category-other').value;

            if (category === 'otros' && categoryOther) {
                category = categoryOther; // Usar el texto libre como categor√≠a
            }
            
            if (!code || isNaN(price) || isNaN(stock) || stock < 0) {
                alert('Por favor, complete los campos obligatorios (c√≥digo, precio y stock inicial) con valores v√°lidos.');
                return;
            }

            const productData = {
                code, name, description, brand, price, stock, unitOfMeasure, animal, category,
                providers: [] // Inicialmente vac√≠o
            };
            
            let endpoint = '/products';
            let method = 'POST';
            
            if (isEditing) {
                const productId = parseInt(document.getElementById('add-product-form').dataset.id);
                productData.id = productId;
                // Mantener los proveedores existentes si estamos editando
                const existingProduct = products.find(p => p.id === productId);
                if (existingProduct) productData.providers = existingProduct.providers;
                
                endpoint = '/products/' + productId;
                method = 'PUT';
            } else if (products.some(p => p.code === code)) {
                alert('Ya existe un producto con este c√≥digo/SKU. Utilice un c√≥digo diferente o edite el producto existente.');
                return;
            }

            const newProduct = await sendData(endpoint, method, productData);

            if (newProduct) {
                alert(isEditing ? 'Producto actualizado con √©xito.' : 'Producto agregado con √©xito.');
                clearProductForm();
                renderAllProducts();
                updateProductSelects();
                updateStats();
            } else {
                alert('Error al guardar el producto.');
            }
        }
        
        function clearProductForm() {
            document.getElementById('add-product-form').reset();
            document.getElementById('add-product-form').removeAttribute('data-id');
            document.getElementById('product-form-title').textContent = '‚ûï Agregar Nuevo Producto';
            document.getElementById('add-product-btn').textContent = 'Agregar Producto';
            document.getElementById('other-product-category-container').classList.add('hidden');
        }

        function editProduct(productId) {
            const product = products.find(p => p.id === productId);
            if (!product) return;
            
            document.getElementById('product-code').value = product.code;
            document.getElementById('product-description').value = product.description;
            document.getElementById('product-brand').value = product.brand;
            document.getElementById('product-price').value = product.price;
            document.getElementById('product-stock').value = product.stock;
            document.getElementById('product-unit-of-measure').value = product.unitOfMeasure;
            document.getElementById('product-animal').value = product.animal;
            
            // Manejo de categor√≠a (si es "otros", selecciona "otros" y llena el campo extra)
            const categories = ['arnes-correas', 'juguetes', 'rascadores-camas', 'higiene-aseo', 'transportadoras', 'ropa', 'otros'];
            if (categories.includes(product.category)) {
                document.getElementById('product-category').value = product.category;
                document.getElementById('other-product-category-container').classList.add('hidden');
            } else {
                document.getElementById('product-category').value = 'otros';
                document.getElementById('product-category-other').value = product.category;
                document.getElementById('other-product-category-container').classList.remove('hidden');
            }

            document.getElementById('add-product-form').dataset.id = productId;
            document.getElementById('product-form-title').textContent = `‚úèÔ∏è Editar Producto: ${product.name}`;
            document.getElementById('add-product-btn').textContent = 'Guardar Cambios';
            
            // Desplazarse al formulario
            document.getElementById('product-form-title').scrollIntoView({ behavior: 'smooth' });
        }

        async function deleteProduct(productId) {
            if (confirm('¬øEst√° seguro de eliminar este producto? Esta acci√≥n no se puede deshacer.')) {
                const success = await deleteData(`/products/${productId}`);
                if (success) {
                    alert('Producto eliminado con √©xito.');
                    renderAllProducts();
                    updateProductSelects();
                    updateStats();
                } else {
                    alert('Error al eliminar el producto.');
                }
            }
        }

        function searchProducts() {
            const query = document.getElementById('product-search').value.toLowerCase();
            const results = products.filter(p => 
                p.code.toLowerCase().includes(query) || 
                p.name.toLowerCase().includes(query) ||
                p.description.toLowerCase().includes(query)
            );
            
            renderProductList(results, 'product-results');
            document.getElementById('product-list-view').innerHTML = ''; // Limpiar la vista completa
        }
        
        function renderAllProducts() {
             document.getElementById('product-results').innerHTML = ''; // Limpiar resultados de b√∫squeda
             renderProductList(products, 'product-list-view');
        }

        function renderProductList(list, targetElementId) {
            const targetElement = document.getElementById(targetElementId);
            if (!targetElement) return;

            if (list.length === 0) {
                targetElement.innerHTML = `<p style="padding: 15px; text-align: center;">${targetElementId === 'product-list-view' ? 'No hay productos registrados.' : 'No se encontraron productos.'}</p>`;
                return;
            }

            let html = `
                <div class="data-table-responsive">
                <table class="data-table">
                    <thead>
                        <tr>
                            <th>C√ìDIGO</th>
                            <th>NOMBRE / DESCRIPCI√ìN</th>
                            <th>MARCA</th>
                            <th>CATEGOR√çA</th>
                            <th>PRECIO VENTA (${currentCurrency})</th>
                            <th>STOCK (${products[0]?.unitOfMeasure || 'UND'})</th>
                            <th>ACCIONES</th>
                        </tr>
                    </thead>
                    <tbody>
            `;

            list.forEach(p => {
                const convertedPrice = convertAndFormat(p.price).replace('$', '');
                let stockClass = 'stock';
                if (p.stock < 10 && p.stock > 0) stockClass = 'low-stock';
                else if (p.stock === 0) stockClass = 'out-of-stock';

                html += `
                    <tr>
                        <td>${p.code}</td>
                        <td>${p.name}</td>
                        <td>${p.brand || 'N/A'}</td>
                        <td>${p.category}</td>
                        <td>${convertedPrice}</td>
                        <td class="${stockClass}">${p.stock}</td>
                        <td class="action-buttons">
                            <button class="edit-btn" onclick="editProduct(${p.id})"><i class="fas fa-edit"></i></button>
                            <button class="delete-btn" onclick="deleteProduct(${p.id})"><i class="fas fa-trash-alt"></i></button>
                        </td>
                    </tr>
                `;
            });

            html += `
                    </tbody>
                </table>
                </div>
            `;
            targetElement.innerHTML = html;
        }

        // --------------------------------------------------------
        // L√ìGICA DE PROVEEDORES
        // --------------------------------------------------------
        
        function updateProviderSelects() {
            const providerSelects = document.querySelectorAll('#invoice-provider, #contact-provider-select');
            
            providerSelects.forEach(select => {
                const selectedValue = select.value;
                select.innerHTML = '<option value="">Seleccione un proveedor</option>';
                
                providers.forEach(provider => {
                    const option = document.createElement('option');
                    option.value = provider.id;
                    option.textContent = `${provider.tradeName} (${provider.name})`;
                    select.appendChild(option);
                });
                
                 if (selectedValue && select.querySelector(`option[value="${selectedValue}"]`)) {
                     select.value = selectedValue;
                }
            });
        }
        
        function getProviderName(id) {
            const provider = providers.find(p => p.id === id);
            return provider ? provider.tradeName : 'Proveedor Desconocido';
        }

        async function addProvider() {
            const isEditing = document.getElementById('add-provider-btn').textContent.includes('Guardar');
            
            const name = document.getElementById('provider-name').value;
            const tradeName = document.getElementById('provider-trade-name').value;
            const phone = document.getElementById('provider-phone').value;
            const fax = document.getElementById('provider-fax').value;
            const address = document.getElementById('provider-address').value;
            const productType = document.getElementById('provider-product-type-text').value;

            if (!name || !tradeName || !phone) {
                alert('Por favor, complete los campos obligatorios (Nombre, Raz√≥n Social y Tel√©fono).');
                return;
            }

            const providerData = { name, tradeName, phone, fax, address, productType };
            let endpoint = '/providers';
            let method = 'POST';

            if (isEditing) {
                const providerId = parseInt(document.getElementById('provider-id-to-edit').value);
                providerData.id = providerId;
                endpoint = '/providers/' + providerId;
                method = 'PUT';
            }

            const newProvider = await sendData(endpoint, method, providerData);

            if (newProvider) {
                alert(isEditing ? 'Proveedor actualizado con √©xito.' : 'Proveedor agregado con √©xito.');
                clearProviderForm();
                renderAllProviders();
                updateProviderSelects();
                updateContactProviderSelect();
                updateStats();
            } else {
                alert('Error al guardar el proveedor.');
            }
        }
        
        function clearProviderForm() {
            document.getElementById('add-provider-form').reset();
            document.getElementById('provider-id-to-edit').value = '';
            document.getElementById('provider-form-title').textContent = '‚ûï Agregar Nuevo Proveedor';
            document.getElementById('add-provider-btn').textContent = 'Agregar Proveedor';
            document.getElementById('cancel-edit-btn').style.display = 'none';
        }

        function editProvider(providerId) {
            const provider = providers.find(p => p.id === providerId);
            if (!provider) return;
            
            document.getElementById('provider-name').value = provider.name;
            document.getElementById('provider-trade-name').value = provider.tradeName;
            document.getElementById('provider-phone').value = provider.phone;
            document.getElementById('provider-fax').value = provider.fax;
            document.getElementById('provider-address').value = provider.address;
            document.getElementById('provider-product-type-text').value = provider.productType;

            document.getElementById('provider-id-to-edit').value = providerId;
            document.getElementById('provider-form-title').textContent = `‚úèÔ∏è Editar Proveedor: ${provider.tradeName}`;
            document.getElementById('add-provider-btn').textContent = 'Guardar Cambios';
            document.getElementById('cancel-edit-btn').style.display = 'inline-block';
            
            // Desplazarse al formulario
            document.getElementById('provider-form-title').scrollIntoView({ behavior: 'smooth' });
        }

        function cancelEditProvider() {
            clearProviderForm();
        }

        async function deleteProvider(providerId) {
            if (confirm('¬øEst√° seguro de eliminar este proveedor? Esta acci√≥n no se puede deshacer.')) {
                // Verificar si tiene facturas asociadas (simulaci√≥n de restricci√≥n FK)
                if (invoices.some(i => i.providerId === providerId)) {
                    alert('No se puede eliminar este proveedor. Primero debe eliminar todas las facturas asociadas a √©l.');
                    return;
                }
                
                const success = await deleteData(`/providers/${providerId}`);
                if (success) {
                    alert('Proveedor eliminado con √©xito.');
                    renderAllProviders();
                    updateProviderSelects();
                    updateContactProviderSelect();
                    updateStats();
                } else {
                    alert('Error al eliminar el proveedor.');
                }
            }
        }
        
        function searchProviders() {
             const query = document.getElementById('provider-search').value.toLowerCase();
             const results = providers.filter(p => 
                 p.name.toLowerCase().includes(query) || 
                 p.tradeName.toLowerCase().includes(query) ||
                 p.phone.includes(query)
             );
             isShowingAllProviders = false;
             renderProviderList(results, 'provider-results');
        }
        
        function viewAllProviders() {
            document.getElementById('provider-search').value = '';
            isShowingAllProviders = true;
            renderAllProviders();
        }
        
        function renderAllProviders() {
            renderProviderList(providers, 'provider-results');
        }

        function renderProviderList(list, targetElementId) {
            const targetElement = document.getElementById(targetElementId);
            if (!targetElement) return;
            
            if (list.length === 0) {
                targetElement.innerHTML = '<p style="padding: 15px; text-align: center;">No hay proveedores registrados que coincidan.</p>';
                return;
            }

            let html = '<div class="card-container">'; 

            list.forEach(p => {
                html += `
                    <div class="provider-card">
                        <h4>${p.tradeName}</h4>
                        <p><strong>Contacto:</strong> ${p.name}</p>
                        <p><strong>Tel√©fono:</strong> ${p.phone}</p>
                        <p><strong>Fax:</strong> ${p.fax || 'N/A'}</p>
                        <p><strong>Productos:</strong> ${p.productType || 'No especificado'}</p>
                        <div class="action-buttons" style="margin-top: 10px;">
                            <button class="edit-btn" onclick="editProvider(${p.id})"><i class="fas fa-edit"></i> Editar</button>
                            <button class="delete-btn" onclick="deleteProvider(${p.id})"><i class="fas fa-trash-alt"></i> Eliminar</button>
                        </div>
                    </div>
                `;
            });

            html += '</div>';
            targetElement.innerHTML = html;
        }

        function updateContactProviderSelect() {
            // Ya implementado en updateProviderSelects, pero esta funci√≥n asegura que se ejecute para la secci√≥n de Contacto
            updateProviderSelects(); 
        }

        function sendEmail() {
            const providerId = parseInt(document.getElementById('contact-provider-select').value);
            const subject = document.getElementById('contact-subject').value;
            const message = document.getElementById('contact-message').value;

            if (!providerId || !subject || !message) {
                alert('Por favor, complete todos los campos de contacto.');
                return;
            }

            const provider = providers.find(p => p.id === providerId);
            
            // Simulaci√≥n: No se puede enviar un correo real sin un backend y servicio SMTP.
            alert(`
                ‚úÖ Correo enviado simulado con √©xito.
                
                Destinatario (Contacto): ${provider.name}
                Asunto: ${subject}
                
                (En una aplicaci√≥n real, este mensaje se enviar√≠a usando el fax/email del proveedor, pero como solo tenemos datos locales, es una simulaci√≥n.)
            `);
            
            document.getElementById('contact-form').reset();
            document.getElementById('contact-subject').value = 'Consulta de Productos y Precios'; // Valor por defecto
            // Resetear el valor de textarea ya que .reset() no siempre funciona como esperamos en todos los navegadores
            document.getElementById('contact-message').value = `Estimados,

Por favor, env√≠enme su lista de precios actualizada y el cat√°logo de productos disponible.

Agradezco su pronta respuesta.`;
        }

        // --------------------------------------------------------
        // L√ìGICA DE FACTURAS (INVOICES)
        // --------------------------------------------------------
        
        // Funci√≥n para autocompletar campos de factura al seleccionar un producto
        function updateProductFields() {
             const productId = parseInt(document.getElementById('invoice-product').value);
             const product = products.find(p => p.id === productId);

             if (product) {
                 // Autocompletar la descripci√≥n y marca del producto
                 document.getElementById('invoice-description').value = product.name;
                 document.getElementById('invoice-brand').value = product.brand || '';
                 document.getElementById('invoice-unit-of-measure').value = product.unitOfMeasure;
                 // Autocompletar el precio de venta sugerido (no el de compra)
                 document.getElementById('invoice-sale-price').value = product.price.toFixed(2);
             } else {
                 // Limpiar si no hay producto seleccionado
                 document.getElementById('invoice-description').value = '';
                 document.getElementById('invoice-brand').value = '';
                 document.getElementById('invoice-unit-of-measure').value = '';
                 document.getElementById('invoice-sale-price').value = '';
             }
             calculateInvoiceTotals();
        }

        function calculateInvoiceTotals() {
            const quantity = parseFloat(document.getElementById('invoice-quantity').value) || 0;
            const unitPrice = parseFloat(document.getElementById('invoice-unit-price').value) || 0;
            const discountRate = parseFloat(document.getElementById('invoice-discount-rate').value) || 0;
            const taxRate = parseFloat(document.getElementById('invoice-tax-rate').value) || 0;
            
            // 1. Calcular el subtotal sin descuento
            let grossBaseAmount = quantity * unitPrice;
            
            // 2. Aplicar descuento (simulaci√≥n: descuento en la base imponible)
            const discountAmount = grossBaseAmount * (discountRate / 100);
            const netBaseAmount = grossBaseAmount - discountAmount;
            
            // 3. Aplicar impuesto
            const taxAmount = netBaseAmount * (taxRate / 100);
            
            // 4. Total
            const total = netBaseAmount + taxAmount;

            document.getElementById('invoice-base-amount').value = netBaseAmount.toFixed(2);
            document.getElementById('invoice-tax-amount').value = taxAmount.toFixed(2);
            document.getElementById('invoice-total').value = total.toFixed(2);
            
            // No hay campo para el monto del descuento, pero lo guardamos internamente en la simulaci√≥n
            document.getElementById('add-invoice-form').dataset.discountAmount = discountAmount.toFixed(2);
        }

        async function addInvoice() {
            const productId = parseInt(document.getElementById('invoice-product').value);
            const providerId = parseInt(document.getElementById('invoice-provider').value);
            const quantity = parseInt(document.getElementById('invoice-quantity').value);
            const unitPrice = parseFloat(document.getElementById('invoice-unit-price').value);
            const total = parseFloat(document.getElementById('invoice-total').value);
            
            if (!productId || !providerId || quantity <= 0 || isNaN(unitPrice) || isNaN(total)) {
                alert('Por favor, complete todos los campos obligatorios de la factura con valores v√°lidos.');
                return;
            }

            const invoiceData = {
                ruc: document.getElementById('invoice-ruc').value,
                invoiceNumber: document.getElementById('invoice-number').value,
                documentType: document.getElementById('invoice-document-type').value,
                providerId,
                productId,
                descriptionFactura: document.getElementById('invoice-description').value,
                brand: document.getElementById('invoice-brand').value,
                unitOfMeasure: document.getElementById('invoice-unit-of-measure').value,
                quantity,
                salePrice: parseFloat(document.getElementById('invoice-sale-price').value),
                unitPrice,
                discountRate: parseFloat(document.getElementById('invoice-discount-rate').value) || 0,
                discountAmount: parseFloat(document.getElementById('add-invoice-form').dataset.discountAmount) || 0,
                baseAmount: parseFloat(document.getElementById('invoice-base-amount').value),
                taxRate: parseFloat(document.getElementById('invoice-tax-rate').value),
                taxAmount: parseFloat(document.getElementById('invoice-tax-amount').value),
                total,
                date: document.getElementById('invoice-date').value,
            };

            const newInvoice = await sendData('/invoices', 'POST', invoiceData);

            if (newInvoice) {
                // 1. Actualizar Stock del Producto
                const product = products.find(p => p.id === productId);
                if (product) {
                    product.stock += quantity;
                    // Tambi√©n actualizamos el precio de venta si es diferente
                    if (product.price !== invoiceData.salePrice) {
                        product.price = invoiceData.salePrice;
                    }
                    saveProducts();
                }
                
                // 2. A√±adir proveedor a la lista de proveedores del producto (para trazabilidad)
                if (product && !product.providers.includes(providerId)) {
                    product.providers.push(providerId);
                    saveProducts();
                }

                alert('Factura registrada y stock actualizado con √©xito.');
                clearInvoiceForm();
                renderInvoices();
                updateStats();
                updateProductSelects(); // Refresca los selects con el nuevo stock
            } else {
                alert('Error al registrar la factura.');
            }
        }

        function clearInvoiceForm() {
            document.getElementById('add-invoice-form').reset();
            document.getElementById('invoice-base-amount').value = '';
            document.getElementById('invoice-tax-amount').value = '';
            document.getElementById('invoice-total').value = '';
        }

        async function deleteInvoice(invoiceId) {
             if (confirm('¬øEst√° seguro de eliminar esta Factura? Se revertir√° la entrada de stock asociada.')) {
                const success = await deleteData(`/invoices/${invoiceId}`);
                if (success) {
                    alert('Factura eliminada y stock revertido con √©xito.');
                    renderInvoices();
                    updateStats();
                    updateProductSelects();
                } else {
                    alert('Error al eliminar la factura o al revertir el stock.');
                }
            }
        }
        
        function getProductName(id) {
             const product = products.find(p => p.id === id);
             return product ? `${product.name} (${product.code})` : 'Producto Desconocido';
        }

        function renderInvoicesOverview() {
             const recentInvoices = invoices
                 .sort((a, b) => new Date(b.date) - new Date(a.date))
                 .slice(0, 5); // Mostrar solo las 5 m√°s recientes
                 
             renderInvoiceList(recentInvoices, 'invoices-list-view-overview');
        }

        function renderInvoices() {
            const allInvoices = invoices.sort((a, b) => new Date(b.date) - new Date(a.date));
            renderInvoiceList(allInvoices, 'invoices-list-view');
            renderInvoicesOverview();
        }

        function renderInvoiceList(list, targetElementId) {
            const targetElement = document.getElementById(targetElementId);
            if (!targetElement) return;

            if (list.length === 0) {
                targetElement.innerHTML = '<p style="text-align: center; margin-top: 10px;">No hay facturas registradas.</p>';
                return;
            }
            
            const isOverview = targetElementId === 'invoices-list-view-overview';

            let html = `
                <table class="data-table">
                    <thead>
                        <tr>
                            <th>FECHA</th>
                            <th>N¬∞ DOC</th>
                            ${isOverview ? '' : '<th>RUC/PROVEEDOR</th>'}
                            <th>PRODUCTO</th>
                            <th>CANT</th>
                            <th>TOTAL (${currentCurrency})</th>
                             ${isOverview ? '' : '<th>ACCIONES</th>'}
                        </tr>
                    </thead>
                    <tbody>
            `;

            list.forEach(i => {
                const totalConverted = convertAndFormat(i.total).replace('$', '');
                
                html += `
                    <tr>
                        <td>${i.date}</td>
                        <td>${i.invoiceNumber}</td>
                        ${isOverview ? '' : `<td>${i.ruc} / ${getProviderName(i.providerId)}</td>`}
                        <td>${i.descriptionFactura || getProductName(i.productId)}</td>
                        <td>${i.quantity}</td>
                        <td>${totalConverted}</td>
                        ${isOverview ? '' : `<td class="action-buttons"><button class="delete-btn" onclick="deleteInvoice(${i.id})"><i class="fas fa-trash-alt"></i></button></td>`}
                    </tr>
                `;
            });

            html += `
                    </tbody>
                </table>
            `;
            targetElement.innerHTML = html;
        }

        // --------------------------------------------------------
        // L√ìGICA DE VENTAS
        // --------------------------------------------------------
        
        async function addSale() {
            const productId = parseInt(document.getElementById('sale-product').value);
            const quantity = parseInt(document.getElementById('sale-quantity').value);
            const unitPrice = parseFloat(document.getElementById('sale-unit-price').value);
            
            const product = products.find(p => p.id === productId);

            if (!productId || quantity <= 0 || isNaN(unitPrice)) {
                alert('Por favor, complete todos los campos obligatorios de la venta con valores v√°lidos.');
                return;
            }
            
            if (product && product.stock < quantity) {
                 alert(`Stock insuficiente. Solo quedan ${product.stock} unidades de ${product.name}.`);
                 return;
            }

            const total = quantity * unitPrice;
            
            const saleData = {
                saleNumber: document.getElementById('sale-number').value,
                client: document.getElementById('sale-client').value,
                productId,
                quantity,
                unitPrice,
                total,
                date: document.getElementById('sale-date').value,
            };

            const newSale = await sendData('/sales', 'POST', saleData);

            if (newSale) {
                // 1. Actualizar Stock del Producto (Restar)
                if (product) {
                    product.stock -= quantity;
                    saveProducts();
                }

                alert('Venta registrada y stock actualizado con √©xito.');
                clearSaleForm();
                renderSales();
                updateStats();
                updateProductSelects(); // Refresca los selects con el nuevo stock
            } else {
                alert('Error al registrar la venta.');
            }
        }

        function clearSaleForm() {
            document.getElementById('add-sale-form').reset();
        }
        
        async function deleteSale(saleId) {
             if (confirm('¬øEst√° seguro de eliminar esta Venta? Se devolver√° el stock al inventario.')) {
                const success = await deleteData(`/sales/${saleId}`);
                if (success) {
                    alert('Venta eliminada y stock devuelto con √©xito.');
                    renderSales();
                    updateStats();
                    updateProductSelects();
                } else {
                    alert('Error al eliminar la venta o al devolver el stock.');
                }
            }
        }

        function renderSalesOverview() {
             const recentSales = sales
                 .sort((a, b) => new Date(b.date) - new Date(a.date))
                 .slice(0, 5); // Mostrar solo las 5 m√°s recientes
                 
             renderSaleList(recentSales, 'sales-list-view-overview');
        }

        function renderSales() {
            const allSales = sales.sort((a, b) => new Date(b.date) - new Date(a.date));
            renderSaleList(allSales, 'sales-list');
            renderSalesOverview();
        }

        function renderSaleList(list, targetElementId) {
            const targetElement = document.getElementById(targetElementId);
            if (!targetElement) return;

            if (list.length === 0) {
                 targetElement.innerHTML = '<p style="text-align: center; margin-top: 10px;">No hay ventas registradas.</p>';
                 return;
            }
            
            const isOverview = targetElementId === 'sales-list-view-overview';

            let html = `
                <table class="data-table">
                    <thead>
                        <tr>
                            <th>FECHA</th>
                            <th>N¬∞ VENTA</th>
                            <th>PRODUCTO</th>
                            ${isOverview ? '' : '<th>CLIENTE</th>'}
                            <th>CANT</th>
                            <th>TOTAL (${currentCurrency})</th>
                             ${isOverview ? '' : '<th>ACCIONES</th>'}
                        </tr>
                    </thead>
                    <tbody>
            `;

            list.forEach(s => {
                const totalConverted = convertAndFormat(s.total).replace('$', '');
                
                html += `
                    <tr>
                        <td>${s.date}</td>
                        <td>${s.saleNumber || 'N/A'}</td>
                        <td>${getProductName(s.productId)}</td>
                        ${isOverview ? '' : `<td>${s.client || 'P√∫blico General'}</td>`}
                        <td>${s.quantity}</td>
                        <td>${totalConverted}</td>
                        ${isOverview ? '' : `<td class="action-buttons"><button class="delete-btn" onclick="deleteSale(${s.id})"><i class="fas fa-trash-alt"></i></button></td>`}
                    </tr>
                `;
            });

            html += `
                    </tbody>
                </table>
            `;
            targetElement.innerHTML = html;
        }

        // --------------------------------------------------------
        // L√ìGICA DE GASTOS
        // --------------------------------------------------------
        
        function calculateExpenseTotal() {
            const quantity = parseFloat(document.getElementById('expense-quantity').value) || 0;
            const unitValue = parseFloat(document.getElementById('expense-unit-value').value) || 0;
            
            const total = quantity * unitValue;
            
            document.getElementById('expense-total').value = total.toFixed(2);
        }
        
        async function addExpense() {
            const total = parseFloat(document.getElementById('expense-total').value);
            
            if (isNaN(total) || total <= 0) {
                alert('El monto del gasto debe ser un valor positivo.');
                return;
            }
            
            const expenseData = {
                description: document.getElementById('expense-description').value,
                type: document.getElementById('expense-type').value,
                quantity: parseFloat(document.getElementById('expense-quantity').value),
                unitValue: parseFloat(document.getElementById('expense-unit-value').value),
                total,
                date: document.getElementById('expense-date').value,
            };
            
            const newExpense = await sendData('/expenses', 'POST', expenseData);
            
            if (newExpense) {
                alert('Gasto registrado con √©xito.');
                clearExpenseForm();
                renderExpenses();
                updateStats();
            } else {
                alert('Error al registrar el gasto.');
            }
        }
        
        function clearExpenseForm() {
            document.getElementById('add-expense-form').reset();
            document.getElementById('expense-total').value = '';
        }
        
        async function deleteExpense(expenseId) {
             if (confirm('¬øEst√° seguro de eliminar este Gasto?')) {
                const success = await deleteData(`/expenses/${expenseId}`);
                if (success) {
                    alert('Gasto eliminado con √©xito.');
                    renderExpenses();
                    updateStats();
                } else {
                    alert('Error al eliminar el gasto.');
                }
            }
        }

        function updateExpenseSummary() {
            const totalExpenses = expenses.reduce((sum, e) => sum + e.total, 0);
            document.getElementById('expense-total-summary').textContent = `Total: ${convertAndFormat(totalExpenses)}`;
        }

        function renderExpenses() {
             const targetElement = document.getElementById('expenses-list');
             if (!targetElement) return;

             if (expenses.length === 0) {
                 targetElement.innerHTML = '<p style="text-align: center; padding: 10px;">No hay gastos operativos registrados.</p>';
                 updateExpenseSummary();
                 return;
             }
             
             // Agrupar y ordenar por fecha (m√°s reciente primero)
             const sortedExpenses = expenses.sort((a, b) => new Date(b.date) - new Date(a.date));

             let html = '';
             
             sortedExpenses.forEach(e => {
                 const totalConverted = convertAndFormat(e.total).replace('$', '');
                 html += `
                    <div class="expense-item">
                        <span>
                            <strong>${e.description}</strong> 
                            <small>(${e.type.charAt(0).toUpperCase() + e.type.slice(1)})</small>
                            <br>
                            <small>${e.date}</small>
                        </span>
                        <span>
                            <strong style="color: var(--danger-color);">${totalConverted}</strong>
                             <button class="delete-btn" onclick="deleteExpense(${e.id})"><i class="fas fa-trash-alt"></i></button>
                        </span>
                    </div>
                 `;
             });
             
             targetElement.innerHTML = html;
             updateExpenseSummary();
        }

        // Inicializar la aplicaci√≥n
        checkSession();
    </script>
</body>
</html>****
